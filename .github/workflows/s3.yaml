name: Build & Deploy Glacier Watch UI to S3

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  S3_BUCKET: gis.csornyei.com

jobs:
    s3_cloudfront_deploy:
      name: Build and Deploy to S3
      runs-on: ubuntu-latest

      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Use Node
          uses: actions/setup-node@v4
          with:
            node-version: 24
            cache: npm

        - name: Install
          run: npm ci

        - name: Build
          env:
            VITE_DATA_SOURCE: cloudfront
            VITE_CLOUDFRONT_API_BASE_URL: ${{ secrets.VITE_CF_URL }}
            VITE_API_BASE_URL: ""
          run: npm run build

        - name: Configure AWS credentials (OIDC)
          uses: aws-actions/configure-aws-credentials@v4
          with:
            role-to-assume: ${{ secrets.ROLE_ARN }}
            aws-region: ${{ secrets.AWS_REGION }}

        - name: Sync to S3
          run: |
            aws s3 sync dist s3://${{ env.S3_BUCKET }}/ --delete

        - name: CloudFront invalidation (optional)
          if: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} != ''
          run: |
            aws cloudfront create-invalidation \
              --distribution-id "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" \
              --paths "/*"